# 自动补全引号功能 BUG 修复测试

## 🐛 问题描述

**原问题：** 在 wxml、vue、html 中添加属性并键入等号时，会自动补全双引号 `=""`。但在补全后的引号内再次输入等号，还会继续输出 `=""`，导致语法错误。

**示例：**
```html
<!-- 期望行为 -->
<view class="container" data-value="a=b"></view>

<!-- 实际行为（修复前）-->
<view class="container" data-value="a=""b"></view>
          输入 =                    ↑ 错误：在引号内又补全了 =""
```

---

## ✅ 修复方案

在触发自动补全前，增加以下检查：

1. **引号内检查**：计算等号前的引号数量，如果为奇数则说明在引号内，不触发补全
2. **属性名检查**：确保等号前有合法的属性名字符
3. **已有引号检查**：检查等号后是否已经有引号，避免重复补全
4. **字符合法性检查**：确保等号前最后一个字符是合法的属性名字符（字母、数字、下划线、冒号、连字符）

---

## 🧪 测试用例

### 测试 1：正常属性赋值（应该触发补全）✅

**输入：**
```html
<view class=
```

**预期结果：**
```html
<view class="█"
```
光标应该在引号中间

---

### 测试 2：在双引号内输入等号（不应该触发补全）✅

**输入：**
```html
<view data-value="a=
```

**预期结果：**
```html
<view data-value="a=
```
不应该补全，保持原样

---

### 测试 3：在单引号内输入等号（不应该触发补全）✅

**输入：**
```html
<view data-value='a=
```

**预期结果：**
```html
<view data-value='a=
```
不应该补全，保持原样

---

### 测试 4：多个属性的情况（应该触发补全）✅

**输入：**
```html
<view class="container" id=
```

**预期结果：**
```html
<view class="container" id="█"
```
光标应该在引号中间

---

### 测试 5：Vue 指令（应该触发补全）✅

**输入：**
```html
<div v-bind:class=
```

**预期结果：**
```html
<div v-bind:class="█"
```
光标应该在引号中间

---

### 测试 6：Vue 简写指令（应该触发补全）✅

**输入：**
```html
<div :class=
```

**预期结果：**
```html
<div :class="█"
```
光标应该在引号中间

---

### 测试 7：等号后已有引号（不应该触发补全）✅

**输入：**
```html
<view class= "container"
```
在等号后输入等号

**预期结果：**
```html
<view class= "container"
```
不应该补全

---

### 测试 8：等号前没有属性名（不应该触发补全）✅

**输入：**
```html
<view =
```

**预期结果：**
```html
<view =
```
不应该补全

---

### 测试 9：等号前有空格（不应该触发补全）✅

**输入：**
```html
<view class =
```
注意 class 后有空格

**预期结果：**
```html
<view class =
```
不应该补全（因为等号前有空格，不符合标准属性写法）

---

### 测试 10：复杂表达式（不应该触发补全）✅

**输入：**
```html
<view :data-value="{ a: 1, b: 2 }" :other=
```
在 other= 后输入

**预期结果：**
```html
<view :data-value="{ a: 1, b: 2 }" :other="█"
```
应该正常补全

---

### 测试 11：嵌套引号场景（不应该触发补全）✅

**输入：**
```html
<view data-json='{"key":"value", "other"=
```
在 other" 后输入等号

**预期结果：**
```html
<view data-json='{"key":"value", "other"=
```
不应该补全（在单引号内）

---

### 测试 12：小程序 wx:if 等指令（应该触发补全）✅

**输入：**
```html
<view wx:if=
```

**预期结果：**
```html
<view wx:if="█"
```
光标应该在引号中间

---

### 测试 13：data-* 属性（应该触发补全）✅

**输入：**
```html
<view data-user-id=
```

**预期结果：**
```html
<view data-user-id="█"
```
光标应该在引号中间

---

## 📝 测试步骤

### 手动测试

1. 在 VS Code 中打开此项目
2. 按 `F5` 启动扩展开发主机
3. 在新窗口中创建测试文件：
   - `test.wxml`
   - `test.vue`
   - `test.html`
4. 逐个测试上述用例
5. 记录测试结果

### 自动化测试（未来可实现）

```javascript
// 测试框架示例
describe('自动补全引号功能', () => {
  it('应该在正常属性赋值时触发补全', () => {
    // 测试代码
  });
  
  it('不应该在引号内触发补全', () => {
    // 测试代码
  });
  
  // ... 更多测试用例
});
```

---

## 🔍 代码逻辑说明

### 修复前的逻辑
```javascript
// 只要输入等号就触发补全
if (change.text === '=') {
  // 直接补全 =""
}
```

### 修复后的逻辑
```javascript
if (change.text === '=') {
  // 1. 检查是否在引号内
  const doubleQuotesBefore = (textBeforeEqual.match(/"/g) || []).length;
  const singleQuotesBefore = (textBeforeEqual.match(/'/g) || []).length;
  if (doubleQuotesBefore % 2 !== 0 || singleQuotesBefore % 2 !== 0) {
    return; // 在引号内，不补全
  }
  
  // 2. 检查等号前是否有属性名
  if (beforeEqual.length === 0 || /\s$/.test(textBeforeEqual)) {
    return; // 没有属性名或有空格，不补全
  }
  
  // 3. 检查最后一个字符是否合法
  if (!/[a-zA-Z0-9_:-]/.test(lastChar)) {
    return; // 不是合法字符，不补全
  }
  
  // 4. 检查等号后是否已有引号
  if (/^\s*["']/.test(textAfterEqual)) {
    return; // 已有引号，不补全
  }
  
  // 通过所有检查，执行补全
}
```

---

## ✅ 测试结果记录表

| 测试用例 | 预期行为 | 实际行为 | 状态 | 备注 |
|---------|---------|---------|------|------|
| 测试 1：正常属性赋值 | 触发补全 | | ⬜ 待测试 | |
| 测试 2：双引号内输入等号 | 不触发补全 | | ⬜ 待测试 | |
| 测试 3：单引号内输入等号 | 不触发补全 | | ⬜ 待测试 | |
| 测试 4：多个属性 | 触发补全 | | ⬜ 待测试 | |
| 测试 5：Vue 指令 | 触发补全 | | ⬜ 待测试 | |
| 测试 6：Vue 简写指令 | 触发补全 | | ⬜ 待测试 | |
| 测试 7：等号后已有引号 | 不触发补全 | | ⬜ 待测试 | |
| 测试 8：等号前没有属性名 | 不触发补全 | | ⬜ 待测试 | |
| 测试 9：等号前有空格 | 不触发补全 | | ⬜ 待测试 | |
| 测试 10：复杂表达式 | 触发补全 | | ⬜ 待测试 | |
| 测试 11：嵌套引号 | 不触发补全 | | ⬜ 待测试 | |
| 测试 12：小程序指令 | 触发补全 | | ⬜ 待测试 | |
| 测试 13：data-* 属性 | 触发补全 | | ⬜ 待测试 | |

**状态说明：**
- ⬜ 待测试
- ✅ 通过
- ❌ 失败

---

## 🐛 已知限制

1. **转义引号**：如果属性值中包含转义引号（如 `\"`），可能会误判
2. **模板字符串**：在 Vue 的模板字符串中可能有特殊情况
3. **注释中的引号**：HTML 注释中的引号会被计入，但这种情况很少见

---

## 📮 反馈

如果发现新的边界情况或问题，请提交 Issue：
https://github.com/Kiraalla/freedom-helper/issues

---

**修复版本**: v0.1.2  
**修复日期**: 2025-11-29  
**修复人员**: Kiraalla
